<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PID Balanced Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; background:#f5f7fb; }
    .row { display:flex; gap:12px; }
    .card { background:#fff; padding:14px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); flex:1; }
    label { display:block; font-size:13px; color:#333; margin-top:8px; }
    input[type=number], input[type=text] { width:100%; padding:8px; font-size:14px; margin-top:6px; box-sizing:border-box; }
    button { margin-top:10px; padding:8px 12px; background:#0078d7;color:#fff;border:none;border-radius:6px;cursor:pointer; }
    button.secondary { background:#666; }
    textarea { width:100%; height:240px; background:#000;color:#0f0; font-family:monospace; padding:8px; border-radius:6px; margin-top:10px; }
    .status { font-weight:700; margin-bottom:8px; }
    .tele { font-size:14px; }
  </style>
</head>
<body>
  <h2>ESP32 PID Balanced Dashboard (esp.local)</h2>
  <div class="row">
    <div class="card">
      <div class="status">Connection: <span id="conn">❌</span></div>

      <label>Target ticks/sec
        <input id="target" type="number" value="400">
      </label>

      <label>Base PWM
        <input id="base" type="number" value="150" min="0" max="255">
      </label>

      <label>Max PWM
        <input id="max" type="number" value="255" min="1" max="255">
      </label>

      <label>Kp (speed)
        <input id="Kp" type="number" step="0.001" value="1.678">
      </label>

      <label>Ki (speed)
        <input id="Ki" type="number" step="0.001" value="-0.020">
      </label>

      <label>Kd (speed)
        <input id="Kd" type="number" step="0.001" value="0.146">
      </label>

      <label>Kp_balance
        <input id="Kpb" type="number" step="0.001" value="0.5">
      </label>

      <div style="margin-top:8px;">
        <button onclick="sendParams()">Update params</button>
        <button class="secondary" onclick="toggleRun()" id="btnRun">Stop</button>
      </div>
    </div>

    <div class="card">
      <div class="tele">
        <div>Left ticks: <span id="L">0</span></div>
        <div>Right ticks: <span id="R">0</span></div>
        <div>pwmL: <span id="pL">0</span> | pwmR: <span id="pR">0</span></div>
        <div>target: <span id="tgt">400</span> | running: <span id="runState">true</span></div>
      </div>

      <h4 style="margin-top:12px">PID Debug Log</h4>
      <textarea id="log" readonly></textarea>
    </div>
  </div>

<script>
  const connEl = document.getElementById('conn');
  const logEl = document.getElementById('log');
  const L = document.getElementById('L'), R = document.getElementById('R');
  const pL = document.getElementById('pL'), pR = document.getElementById('pR');
  const tgt = document.getElementById('tgt'), runState = document.getElementById('runState');
  const btnRun = document.getElementById('btnRun');

  // connect to esp.local
  const ws = new WebSocket('ws://esp.local/ws');

  ws.onopen = () => {
    connEl.textContent = '✅';
    addLog('[ws] connected');
    requestPing();
  };
  ws.onclose = () => {
    connEl.textContent = '❌';
    addLog('[ws] disconnected');
  };
  ws.onerror = (e) => {
    addLog('[ws] error');
  };
  ws.onmessage = (ev) => {
    try {
      const d = JSON.parse(ev.data);
      if (d.L !== undefined) L.textContent = d.L;
      if (d.R !== undefined) R.textContent = d.R;
      if (d.pwmL !== undefined) pL.textContent = d.pwmL;
      if (d.pwmR !== undefined) pR.textContent = d.pwmR;
      if (d.target !== undefined) tgt.textContent = d.target;
      if (d.running !== undefined) {
        runState.textContent = d.running ? 'true' : 'false';
        btnRun.textContent = d.running ? 'Stop' : 'Start';
      }
      if (d.debug) {
        addLog('[esp] ' + d.debug);
      }
      // reflect updated params
      if (d.Kp !== undefined) document.getElementById('Kp').value = d.Kp;
      if (d.Ki !== undefined) document.getElementById('Ki').value = d.Ki;
      if (d.Kd !== undefined) document.getElementById('Kd').value = d.Kd;
      if (d.Kpb !== undefined) document.getElementById('Kpb').value = d.Kpb;
      if (d.base !== undefined) document.getElementById('base').value = d.base;
      if (d.max !== undefined) document.getElementById('max').value = d.max;
    } catch (err) {
      addLog('[ws] raw: ' + ev.data);
    }
  };

  function addLog(s) {
    logEl.value += s + '\n';
    logEl.scrollTop = logEl.scrollHeight;
  }

  function sendParams() {
    const payload = {
      target: parseInt(document.getElementById('target').value),
      base: parseInt(document.getElementById('base').value),
      max: parseInt(document.getElementById('max').value),
      Kp: parseFloat(document.getElementById('Kp').value),
      Ki: parseFloat(document.getElementById('Ki').value),
      Kd: parseFloat(document.getElementById('Kd').value),
      Kpb: parseFloat(document.getElementById('Kpb').value)
    };
    addLog('[gui] sending params');
    ws.send(JSON.stringify(payload));
  }

  function toggleRun() {
    const want = (btnRun.textContent === 'Start');
    ws.send(JSON.stringify({ run: want }));
    addLog(`[gui] set run=${want}`);
  }

  // ask the ESP for a status ping (get immediate telemetry)
  function requestPing() {
    ws.send(JSON.stringify({ ping: true }));
  }

  // request periodic ping every 10s (helpful if telemetry stops)
  setInterval(requestPing, 10000);
</script>
</body>
</html>
