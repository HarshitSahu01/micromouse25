<!DOCTYPE html>
<html>
<head>
  <title>ESP32 PID Auto-Tuner</title>
</head>
<body>
  <h2>PID Auto-Tuning</h2>
  <pre id="log"></pre>
  <script>
    let ws = new WebSocket("ws://esp32.local:81");

    ws.onopen = () => log("Connected to ESP32");
    ws.onmessage = (evt) => {
      let data = JSON.parse(evt.data);
      log("Error: " + data.error);
      twiddleStep(data.error);
    };

    function log(msg) {
      document.getElementById("log").textContent += msg + "\\n";
    }

    // ==== Twiddle ====
    let p = [1.0, 0.0, 0.0];   // Kp, Ki, Kd
    let dp = [0.5, 0.05, 0.05];
    let bestError = Infinity;
    let index = 0;
    let state = 0;

    function twiddleStep(error) {
      if (error < bestError) {
        bestError = error;
        dp[index] *= 1.1;
        index = (index + 1) % 3;
        state = 0;
      } else {
        if (state === 0) {
          p[index] -= 2 * dp[index];
          state = 1;
          sendPID();
          return;
        } else {
          p[index] += dp[index];
          dp[index] *= 0.9;
          index = (index + 1) % 3;
          state = 0;
        }
      }
      sendPID();
    }

    function sendPID() {
      let msg = {
        Kp: p[0],
        Ki: p[1],
        Kd: p[2],
        base: 120
      };
      log("Testing PID: " + JSON.stringify(msg));
      ws.send(JSON.stringify(msg));
    }

    // start
    ws.onopen = () => {
      log("Connected, starting tuning...");
      sendPID();
    };
  </script>
</body>
</html>
