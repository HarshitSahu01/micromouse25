<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>PID Dashboard</title>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
    }

    label,
    button {
      display: block;
      margin: 8px 0;
    }

    textarea {
      width: 100%;
      height: 200px;
      background: #222;
      color: #0f0;
    }

    #status {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-left: 8px;
    }

    .connected {
      background: #0a0;
      color: #fff;
    }

    .disconnected {
      background: #a00;
      color: #fff;
    }
  </style>
</head>

<body>
  <h2>PID Control Dashboard</h2>

  <div>
    Connection Status:
    <span id="status" class="disconnected">Disconnected</span>
    <button onclick="manualReconnect()">Reconnect</button>
  </div>

  <label>Start Distance (cm): <input type="number" id="startDist" value="50"></label>
  <button onclick="startRun()">Start</button>
  <button onclick="stopRun()">Stop</button>

  <h3>PID Constants</h3>
  <label>Kp: <input type="number" id="Kp" step="0.01" value="1.0"></label>
  <label>Ki: <input type="number" id="Ki" step="0.01" value="0.0"></label>
  <label>Kd: <input type="number" id="Kd" step="0.01" value="0.0"></label>
  <button onclick="updatePID()">Update PID</button>

  <h3>Debug Log</h3>
  <textarea id="debugLog" readonly></textarea>

  <script>
    const debugLogEl = document.getElementById('debugLog');
    const statusEl = document.getElementById('status');
    let ws;   // keep reference
    let reconnectInterval = 2000; // 2 seconds
    let reconnectTimer;

    // ---- WebSocket connection handling ----
    function connectWS() {
      ws = new WebSocket('ws://esp32.local/ws');

      ws.onopen = () => {
        console.log('WS connected');
        setStatus(true);
        clearTimeout(reconnectTimer); // stop retry loop
      };

      ws.onclose = () => {
        console.log('WS disconnected');
        setStatus(false);
        // retry after 2s
        reconnectTimer = setTimeout(connectWS, reconnectInterval);
      };

      ws.onmessage = e => {
        const d = JSON.parse(e.data);
        if (d.debug) {
          debugLogEl.value += d.debug + '\n';
          debugLogEl.scrollTop = debugLogEl.scrollHeight;
        }
      };
    }

    function manualReconnect() {
      if (ws) {
        ws.close(); // triggers reconnect
      } else {
        connectWS();
      }
    }

    function setStatus(connected) {
      if (connected) {
        statusEl.textContent = "Connected";
        statusEl.className = "connected";
      } else {
        statusEl.textContent = "Disconnected";
        statusEl.className = "disconnected";
      }
    }

    // ---- PID value persistence ----
    function loadPID() {
      ['Kp', 'Ki', 'Kd'].forEach(k => {
        const val = localStorage.getItem(k);
        if (val !== null) {
          document.getElementById(k).value = val;
        }
      });
    }

    function savePID() {
      ['Kp', 'Ki', 'Kd'].forEach(k => {
        const val = document.getElementById(k).value;
        localStorage.setItem(k, val);
      });
    }

    // ---- Actions ----
    function startRun() {
      const val = parseFloat(document.getElementById('startDist').value);
      ws.send(JSON.stringify({ start: val }));
    }

    function stopRun() {
      ws.send(JSON.stringify({ stop: true }));
    }

    function updatePID() {
      const Kp = parseFloat(document.getElementById('Kp').value);
      const Ki = parseFloat(document.getElementById('Ki').value);
      const Kd = parseFloat(document.getElementById('Kd').value);

      // save values to localStorage
      savePID();

      ws.send(JSON.stringify({ Kp, Ki, Kd }));
    }

    // ---- Init ----
    window.addEventListener('load', () => {
      loadPID();
      connectWS();
    });
  </script>
</body>

</html>
